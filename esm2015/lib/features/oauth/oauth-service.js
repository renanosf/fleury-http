import { __awaiter } from "tslib";
import { OauthFlows } from './interfaces/ioauth';
import { OauthSensediaService } from './implementations/oauth-sensedia-service';
export class OauthService {
    constructor(config, fleuryHttpEvents, httpClientService, storageService) {
        this.config = config;
        this.fleuryHttpEvents = fleuryHttpEvents;
        this.httpClientService = httpClientService;
        this.storageService = storageService;
        this.oauthProvider = new OauthSensediaService(this.config, this.httpClientService);
        this.clientId = this.config.oauth.application.clientId;
        const token = this.storageService.get(this.clientId);
        if (token)
            this.currentToken = JSON.parse(token);
        if (this.config.lazyAuhtorization) {
            this.fleuryHttpEvents.isReady.next(true);
        }
        else {
            if (!this.currentToken)
                this.refreshToken();
            else
                this.fleuryHttpEvents.isReady.next(true);
        }
    }
    grantFlow() {
        return __awaiter(this, void 0, void 0, function* () {
            const code = yield this.oauthProvider.callGrantCode();
            const response = yield this.oauthProvider.callAccessToken(code);
            this.currentToken = {
                accessToken: response.access_token,
                expires: new Date().getTime() + (response.expires_in * OauthService.MILLISECONDS),
                refreshToken: response.refresh_token
            };
            console.log(this.currentToken);
            this.storageService.set(this.clientId, JSON.stringify(this.currentToken));
            return this.currentToken.accessToken;
        });
    }
    implicitFlow() {
        return __awaiter(this, void 0, void 0, function* () {
            const response = yield this.oauthProvider.callAccessTokenImplicit();
            this.currentToken = {
                accessToken: response.access_token,
                expires: new Date().getTime() + (response.expires_in * OauthService.MILLISECONDS),
            };
            this.storageService.set(this.clientId, JSON.stringify(this.currentToken));
            return this.currentToken.accessToken;
        });
    }
    isTokenValid() {
        return this.currentToken ? new Date().getTime() < this.currentToken.expires : false;
    }
    getAccessToken() {
        return this.currentToken.accessToken;
    }
    getApplicationId() {
        return this.clientId;
    }
    refreshToken() {
        let promise = null;
        this.fleuryHttpEvents.isReady.next(false);
        switch (this.config.oauth.flow) {
            case OauthFlows.IMPLICIT:
                promise = this.implicitFlow();
                break;
            case OauthFlows.GRANT:
            default:
                promise = this.grantFlow();
                break;
        }
        promise.then(() => {
            this.fleuryHttpEvents.isReady.next(true);
        }).catch((err) => {
            this.fleuryHttpEvents.onError.next(err);
        });
    }
}
OauthService.MILLISECONDS = 1000;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2F1dGgtc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9SZW5hbi9wcm9qZWN0cy9mbGV1cnkvbGlicmFyaWVzL215LXdvcmtzcGFjZS9wcm9qZWN0cy9mbGV1cnktaHR0cC9zcmMvIiwic291cmNlcyI6WyJsaWIvZmVhdHVyZXMvb2F1dGgvb2F1dGgtc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBZSxNQUFNLHFCQUFxQixDQUFDO0FBRTlELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBS2hGLE1BQU0sT0FBTyxZQUFZO0lBTXJCLFlBQ1ksTUFBbUIsRUFDbkIsZ0JBQWtDLEVBQ2xDLGlCQUFxQyxFQUNyQyxjQUErQjtRQUgvQixXQUFNLEdBQU4sTUFBTSxDQUFhO1FBQ25CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFvQjtRQUNyQyxtQkFBYyxHQUFkLGNBQWMsQ0FBaUI7UUFFdkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLG9CQUFvQixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDbkYsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyRCxJQUFJLEtBQUs7WUFBRSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFakQsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFO1lBQy9CLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElB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Q0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOztBQW5GYyx5QkFBWSxHQUFXLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9hdXRoRmxvd3MsIElPYXV0aFRva2VuIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2lvYXV0aCc7XHJcbmltcG9ydCB7IElGbGV1cnlIdHRwIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9pZmxldXJ5LWh0dHAnO1xyXG5pbXBvcnQgeyBPYXV0aFNlbnNlZGlhU2VydmljZSB9IGZyb20gJy4vaW1wbGVtZW50YXRpb25zL29hdXRoLXNlbnNlZGlhLXNlcnZpY2UnO1xyXG5pbXBvcnQgeyBJSHR0cENsaWVudFNlcnZpY2UgfSBmcm9tICcuLi9odHRwQ2xpZW50L2ludGVyZmFjZXMvaWh0dHAtY2xpZW50JztcclxuaW1wb3J0IHsgSVN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9pbnRlcmZhY2VzL2lzdG9yYWdlJztcclxuaW1wb3J0IHsgRmxldXJ5SHR0cEV2ZW50cyB9IGZyb20gJy4uL2V2ZW50cy9mbGV1cnktaHR0cC1ldmVudHMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIE9hdXRoU2VydmljZSB7XHJcbiAgICBwcml2YXRlIG9hdXRoUHJvdmlkZXI6IE9hdXRoU2Vuc2VkaWFTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSBjbGllbnRJZDogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgTUlMTElTRUNPTkRTOiBudW1iZXIgPSAxMDAwO1xyXG4gICAgcHJpdmF0ZSBjdXJyZW50VG9rZW46IElPYXV0aFRva2VuO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgY29uZmlnOiBJRmxldXJ5SHR0cCxcclxuICAgICAgICBwcml2YXRlIGZsZXVyeUh0dHBFdmVudHM6IEZsZXVyeUh0dHBFdmVudHMsXHJcbiAgICAgICAgcHJpdmF0ZSBodHRwQ2xpZW50U2VydmljZTogSUh0dHBDbGllbnRTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgc3RvcmFnZVNlcnZpY2U6IElTdG9yYWdlU2VydmljZVxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5vYXV0aFByb3ZpZGVyID0gbmV3IE9hdXRoU2Vuc2VkaWFTZXJ2aWNlKHRoaXMuY29uZmlnLCB0aGlzLmh0dHBDbGllbnRTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLmNsaWVudElkID0gdGhpcy5jb25maWcub2F1dGguYXBwbGljYXRpb24uY2xpZW50SWQ7XHJcbiAgICAgICAgY29uc3QgdG9rZW4gPSB0aGlzLnN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLmNsaWVudElkKTtcclxuICAgICAgICBpZiAodG9rZW4pIHRoaXMuY3VycmVudFRva2VuID0gSlNPTi5wYXJzZSh0b2tlbik7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5sYXp5QXVodG9yaXphdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLmZsZXVyeUh0dHBFdmVudHMuaXNSZWFkeS5uZXh0KHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jdXJyZW50VG9rZW4pIHRoaXMucmVmcmVzaFRva2VuKCk7XHJcbiAgICAgICAgICAgIGVsc2UgdGhpcy5mbGV1cnlIdHRwRXZlbnRzLmlzUmVhZHkubmV4dCh0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBncmFudEZsb3coKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICAgICAgICBjb25zdCBjb2RlID0gYXdhaXQgdGhpcy5vYXV0aFByb3ZpZGVyLmNhbGxHcmFudENvZGUoKTtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMub2F1dGhQcm92aWRlci5jYWxsQWNjZXNzVG9rZW4oY29kZSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5jdXJyZW50VG9rZW4gPSB7XHJcbiAgICAgICAgICAgIGFjY2Vzc1Rva2VuOiByZXNwb25zZS5hY2Nlc3NfdG9rZW4sXHJcbiAgICAgICAgICAgIGV4cGlyZXM6IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgKHJlc3BvbnNlLmV4cGlyZXNfaW4gKiBPYXV0aFNlcnZpY2UuTUlMTElTRUNPTkRTKSxcclxuICAgICAgICAgICAgcmVmcmVzaFRva2VuOiByZXNwb25zZS5yZWZyZXNoX3Rva2VuXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5jdXJyZW50VG9rZW4pO1xyXG5cclxuICAgICAgICB0aGlzLnN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLmNsaWVudElkLCBKU09OLnN0cmluZ2lmeSh0aGlzLmN1cnJlbnRUb2tlbikpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VG9rZW4uYWNjZXNzVG9rZW47XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBpbXBsaWNpdEZsb3coKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMub2F1dGhQcm92aWRlci5jYWxsQWNjZXNzVG9rZW5JbXBsaWNpdCgpO1xyXG5cclxuICAgICAgICB0aGlzLmN1cnJlbnRUb2tlbiA9IHtcclxuICAgICAgICAgICAgYWNjZXNzVG9rZW46IHJlc3BvbnNlLmFjY2Vzc190b2tlbixcclxuICAgICAgICAgICAgZXhwaXJlczogbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAocmVzcG9uc2UuZXhwaXJlc19pbiAqIE9hdXRoU2VydmljZS5NSUxMSVNFQ09ORFMpLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuc3RvcmFnZVNlcnZpY2Uuc2V0KHRoaXMuY2xpZW50SWQsIEpTT04uc3RyaW5naWZ5KHRoaXMuY3VycmVudFRva2VuKSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRUb2tlbi5hY2Nlc3NUb2tlbjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgaXNUb2tlblZhbGlkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRUb2tlbiA/IG5ldyBEYXRlKCkuZ2V0VGltZSgpIDwgdGhpcy5jdXJyZW50VG9rZW4uZXhwaXJlcyA6IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRBY2Nlc3NUb2tlbigpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRUb2tlbi5hY2Nlc3NUb2tlbjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QXBwbGljYXRpb25JZCgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNsaWVudElkO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZnJlc2hUb2tlbigpOiB2b2lkIHtcclxuICAgICAgICBsZXQgcHJvbWlzZTogUHJvbWlzZTxhbnk+ID0gbnVsbDtcclxuICAgICAgICB0aGlzLmZsZXVyeUh0dHBFdmVudHMuaXNSZWFkeS5uZXh0KGZhbHNlKTtcclxuICAgICAgICBcclxuICAgICAgICBzd2l0Y2ggKHRoaXMuY29uZmlnLm9hdXRoLmZsb3cpIHtcclxuICAgICAgICAgICAgY2FzZSBPYXV0aEZsb3dzLklNUExJQ0lUOlxyXG4gICAgICAgICAgICAgICAgcHJvbWlzZSA9IHRoaXMuaW1wbGljaXRGbG93KCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBPYXV0aEZsb3dzLkdSQU5UOlxyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgcHJvbWlzZSA9IHRoaXMuZ3JhbnRGbG93KCk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByb21pc2UudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuZmxldXJ5SHR0cEV2ZW50cy5pc1JlYWR5Lm5leHQodHJ1ZSk7XHJcbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmZsZXVyeUh0dHBFdmVudHMub25FcnJvci5uZXh0KGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuIl19