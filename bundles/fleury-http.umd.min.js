!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("axios"),require("rxjs/operators"),require("rxjs")):"function"==typeof define&&define.amd?define("fleury-http",["exports","axios","rxjs/operators","rxjs"],e):e((t=t||self)["fleury-http"]={},t.axios,t.rxjs.operators,t.rxjs)}(this,(function(t,e,n,r){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;function i(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,c)}a((r=r.apply(t,e||[])).next())}))}function o(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}Object.create;function s(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}Object.create;var c,a=function(){function t(t){this.baseUrl=t,this.axiosInstance=e.create({baseURL:this.baseUrl})}return t.prototype.post=function(t,e,n){return i(this,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:return[4,this.axiosInstance.post(t,e,{headers:n})];case 1:return r=i.sent(),[2,{body:r.data,headers:r.headers,status:r.status,statusText:r.statusText}]}}))}))},t}(),u=function(){function t(){}return t.createHttpService=function(t){return new a(t.baseUrl)},t}();(c=t.OauthFlows||(t.OauthFlows={}))[c.GRANT=0]="GRANT",c[c.IMPLICIT=1]="IMPLICIT";var h,f=function(t,e){var n=e.indexOf(t)+t.length;return e.substring(n)},l=new Function("try {return this===window;}catch(e){ return false;}"),p=function(){function t(t,e){this.config=t,this.http=e,this.appConfig=this.config.oauth.application}return t.prototype.callGrantCode=function(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,this.http.post("/oauth/grant-code",{client_id:this.appConfig.clientId,redirect_uri:this.config.baseUrl+"/oauth/access-token"})];case 1:if(201===(t=e.sent()).status)return[2,f("?code=",t.body.redirect_uri)];throw new Error("Unable to call grant")}}))}))},t.prototype.callAccessToken=function(t){return i(this,void 0,void 0,(function(){var e,n,r;return o(this,(function(i){switch(i.label){case 0:return e=this.appConfig.clientId+":"+this.appConfig.secret,n="Basic "+(o=e,l()?btoa(o):new Buffer(o).toString("base64")),[4,this.http.post("/oauth/access-token",{grant_type:"authorization_code",code:t},{client_id:this.appConfig.clientId,Authorization:n})];case 1:if(201===(r=i.sent()).status)return[2,r.body];throw new Error("Unable to call access token")}var o}))}))},t.prototype.callAccessTokenImplicit=function(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,this.http.post("/oauth/access-token",{client_id:this.appConfig.clientId,grant_type:"implicit",recaptcha:!0,redirect_uri:this.config.baseUrl+"/oauth/access-token"})];case 1:if(201===(t=e.sent()).status)return t.body.access_token=f("?access_token=",t.body.redirect_uri),[2,t.body];throw new Error("Unable to call access token")}}))}))},t}(),d=function(){function e(t,e,n,r){this.config=t,this.fleuryHttpEvents=e,this.httpClientService=n,this.storageService=r,this.oauthProvider=new p(this.config,this.httpClientService),this.clientId=this.config.oauth.application.clientId;var i=this.storageService.get(this.clientId);i&&(this.currentToken=JSON.parse(i)),this.config.lazyAuhtorization||this.currentToken?this.fleuryHttpEvents.isReady.next(!0):this.refreshToken()}return e.prototype.grantFlow=function(){return i(this,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return[4,this.oauthProvider.callGrantCode()];case 1:return t=r.sent(),[4,this.oauthProvider.callAccessToken(t)];case 2:return n=r.sent(),this.currentToken={accessToken:n.access_token,expires:(new Date).getTime()+n.expires_in*e.MILLISECONDS,refreshToken:n.refresh_token},console.log(this.currentToken),this.storageService.set(this.clientId,JSON.stringify(this.currentToken)),[2,this.currentToken.accessToken]}}))}))},e.prototype.implicitFlow=function(){return i(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,this.oauthProvider.callAccessTokenImplicit()];case 1:return t=n.sent(),this.currentToken={accessToken:t.access_token,expires:(new Date).getTime()+t.expires_in*e.MILLISECONDS},this.storageService.set(this.clientId,JSON.stringify(this.currentToken)),[2,this.currentToken.accessToken]}}))}))},e.prototype.isTokenValid=function(){return!!this.currentToken&&(new Date).getTime()<this.currentToken.expires},e.prototype.getAccessToken=function(){return this.currentToken.accessToken},e.prototype.getApplicationId=function(){return this.clientId},e.prototype.refreshToken=function(){var e=this,n=null;switch(this.fleuryHttpEvents.isReady.next(!1),this.config.oauth.flow){case t.OauthFlows.IMPLICIT:n=this.implicitFlow();break;case t.OauthFlows.GRANT:default:n=this.grantFlow()}n.then((function(){e.fleuryHttpEvents.isReady.next(!0)})).catch((function(t){e.fleuryHttpEvents.onError.next(t)}))},e}();d.MILLISECONDS=1e3,(h=t.StorageType||(t.StorageType={}))[h.LocalStorage=0]="LocalStorage",h[h.SessionStorage=1]="SessionStorage",h[h.Memory=2]="Memory";var v,y=function(){function t(){}return t.prototype.get=function(t){return localStorage.getItem(t)},t.prototype.set=function(t,e){localStorage.setItem(t,e)},t}(),g=function(){function t(){}return t.prototype.get=function(t){return sessionStorage.getItem(t)},t.prototype.set=function(t,e){sessionStorage.setItem(t,e)},t}(),b=function(){function t(){this.data={}}return t.prototype.get=function(t){return this.data[t]},t.prototype.set=function(t,e){this.data[t]=e},t}(),S=function(){function e(){}return e.createStorageService=function(e){switch(e.storageType){case t.StorageType.Memory:return new b;case t.StorageType.SessionStorage:return new g;case t.StorageType.LocalStorage:default:return new y}},e}();(v=t.InstanceType||(t.InstanceType={}))[v.Axios=0]="Axios";var w,T,k,I=[function(t){return 0!=t.url.indexOf("http://")&&0!=t.url.indexOf("https://")||-1!==t.url.indexOf(t.baseUrl)},function(t){return!["/oauth/"].filter((function(e){return-1!==t.url.indexOf(e)})).length}],x=[function(t){return i(void 0,void 0,void 0,(function(){return o(this,(function(e){return[2,new Promise((function(e){t.url=-1===t.url.indexOf(t.baseUrl)?t.baseUrl+t.url:t.url,e(t)}))]}))}))},function(t){return i(void 0,void 0,void 0,(function(){return o(this,(function(e){return[2,new Promise((function(e){t.fleuryHttpEvents.isReady.pipe(n.filter((function(t){return t})),n.take(1)).subscribe((function(){t.oauthService.isTokenValid()||t.oauthService.refreshToken(),e(t)}))}))]}))}))},function(t){return i(void 0,void 0,void 0,(function(){return o(this,(function(e){return[2,new Promise((function(e){t.fleuryHttpEvents.isReady.pipe(n.filter((function(t){return t})),n.take(1)).subscribe((function(){t.headers.access_token=t.oauthService.getAccessToken(),t.headers.client_id=t.oauthService.getApplicationId(),e(t)}))}))]}))}))}],E=[function(t){return 401===t.status&&t.oauthService.refreshToken(),!0}],m=function(){function t(t,e,n){this.config=t,this.fleuryHttpEvents=e,this.oauthService=n}return t.prototype.requestTransformation=function(t){var e=-1===t.url.indexOf(this.config.baseUrl)?this.config.baseUrl:"";return{baseUrl:this.config.baseUrl,headers:t.headers,url:e+t.url,body:t.data,fleuryHttpEvents:this.fleuryHttpEvents,oauthService:this.oauthService}},t.prototype.handle=function(t){var e=this;t.interceptors.request.use((function(t){return e.preValidators(t)})),t.interceptors.response.use((function(t){return e.posValidators(t)}))},t.prototype.preModifiers=function(t){return i(this,void 0,void 0,(function(){var e,n,r,i,c,a;return o(this,(function(o){switch(o.label){case 0:e=this.requestTransformation(t),o.label=1;case 1:o.trys.push([1,6,7,8]),n=s(x),r=n.next(),o.label=2;case 2:return r.done?[3,5]:[4,(0,r.value)(e)];case 3:e=o.sent(),o.label=4;case 4:return r=n.next(),[3,2];case 5:return[3,8];case 6:return i=o.sent(),c={error:i},[3,8];case 7:try{r&&!r.done&&(a=n.return)&&a.call(n)}finally{if(c)throw c.error}return[7];case 8:return t.headers=e.headers,t.data=e.body,t.url=e.url,[2,t]}}))}))},t.prototype.preValidators=function(t){return i(this,void 0,void 0,(function(){var e;return o(this,(function(n){return e=this.requestTransformation(t),[2,I.find((function(t){return!1===t(e)}))?t:this.preModifiers(t)]}))}))},t.prototype.posValidators=function(t){return i(this,void 0,void 0,(function(){var e=this;return o(this,(function(n){return E.forEach((function(n){n({oauthService:e.oauthService,status:t.status})})),[2,t]}))}))},t}(),O=function(){function e(t,e,n){var r=this;this.config=t,this.fleuryHttpEvents=e,this.ouathService=n,this.axiosInterceptor=new m(this.config,this.fleuryHttpEvents,this.ouathService),Array.isArray(this.config.instances)&&this.config.instances.forEach((function(t){return r.handleInstance(t)}))}return e.prototype.handleInstance=function(e){switch(e.type){case t.InstanceType.Axios:default:this.axiosInterceptor.handle(e.value)}},e.prototype.checkIfInstanceAlreadyExists=function(t){return!!this.config.instances.find((function(e){return e.value===t.value}))},e.prototype.addInstance=function(t){Array.isArray(this.config.instances)||(this.config.instances=[]),this.checkIfInstanceAlreadyExists(t)||(this.handleInstance(t),this.config.instances.push(t))},e}(),A=function(){this.onError=new r.Subject,this.isReady=new r.BehaviorSubject(!1)},H=function(t){this.config=t,this.fleuryHttpEvents=new A,this.httpClientService=u.createHttpService(this.config),this.storageService=S.createStorageService(this.config),this.oauthService=new d(this.config,this.fleuryHttpEvents,this.httpClientService,this.storageService),this.interceptorService=new O(this.config,this.fleuryHttpEvents,this.oauthService)},_=(k=null,function(t){return k?w:(k=t)?(T={isReady:k.fleuryHttpEvents.isReady.asObservable(),onError:k.fleuryHttpEvents.onError.asObservable()},w={addInstance:function(t){k.interceptorService.addInstance(t)},events:T}):null}),C=function(){function t(){}return t.createFleuryHttp=function(t){return _(null)||_(new H(t)),_(null)},t}();t.FleuryHttpFactory=C,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=fleury-http.umd.min.js.map